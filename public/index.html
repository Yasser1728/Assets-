<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assets Pi App - Final Step</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root { --gold: #d4af37; --dark-bg: #0a0a0a; --card-bg: #161616; }
        body { margin: 0; background-color: var(--dark-bg); color: white; font-family: sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .container { text-align: center; padding: 40px; background: var(--card-bg); border: 1px solid var(--gold); border-radius: 24px; max-width: 380px; width: 90%; }
        .btn { padding: 14px 28px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; width: 100%; margin-top: 15px; }
        .btn-primary { background-color: var(--gold); color: black; }
        .btn-pay { background-color: #4caf50; color: white; display: none; }
        #status { margin-top: 20px; font-size: 0.9rem; color: #b0b0b0; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: var(--gold);">ASSETS.PI</h1>
        <p>Final Step: Process Transaction</p>
        
        <button id="connectBtn" class="btn btn-primary">1. Connect Wallet</button>
        <button id="payBtn" class="btn btn-pay">2. Pay 1 Test-Pi</button>
        
        <div id="status">Ready to finalize...</div>
    </div>

    <script>
        Pi.init({ version: "2.0", sandbox: true });

        const connectBtn = document.getElementById('connectBtn');
        const payBtn = document.getElementById('payBtn');
        const statusEl = document.getElementById('status');

        // 1. الاتصال بالمحفظة
        connectBtn.addEventListener('click', async () => {
            try {
                const scopes = ['username', 'payments'];
                const auth = await Pi.authenticate(scopes, (payment) => {
                    console.log("Incomplete payment found", payment);
                });
                statusEl.textContent = `Welcome, ${auth.user.username}! Now press Pay.`;
                connectBtn.style.display = 'none';
                payBtn.style.display = 'block';
            } catch (err) {
                statusEl.textContent = "Connection failed.";
            }
        });

        // 2. إجراء معاملة الدفع (الخطوة 10)
        payBtn.addEventListener('click', async () => {
            try {
                statusEl.textContent = "Opening Wallet...";
                const payment = await Pi.createPayment({
                    amount: 1.0,
                    memo: "Test payment for Assets App validation",
                    metadata: { assetId: "test-123" },
                }, {
                    onReadyForServerApproval: (paymentId) => {
                        console.log("Payment ID:", paymentId);
                        // في التجربة، مجرد الوصول هنا يعني النجاح تقريبًا
                        statusEl.textContent = "Payment processing...";
                    },
                    onReadyForServerCompletion: (paymentId, txid) => {
                        statusEl.textContent = "Transaction Successful! Check Checklist.";
                        payBtn.disabled = true;
                    },
                    onCancel: (paymentId) => { statusEl.textContent = "Payment Cancelled."; },
                    onError: (error, payment) => { statusEl.textContent = "Error occurred."; }
                });
            } catch (err) {
                statusEl.textContent = "Payment failed to start.";
            }
        });
    </script>
</body>
</html>
